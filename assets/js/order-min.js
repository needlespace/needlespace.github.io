let boxColor="",boxQty=1,PRODUCT_MAP={},CATALOG_DEFAULTS={maxQty:6,shippingTiers:[{max:3,cost:5},{max:6,cost:8}],currency:"USD"};function showLoading(t="cart-items"){const e=document.getElementById(t);if(!e)return;e.innerHTML="";const r=document.createElement("div");r.className="loading",r.textContent="Loading...",e.appendChild(r)}function showError(t,e="cart-items",r){const o=document.getElementById(e);if(!o)return;o.innerHTML="";const n=document.createElement("div");n.className="error-message";const a=document.createElement("p");if(a.textContent=t,n.appendChild(a),"function"==typeof r){const t=document.createElement("button");t.textContent="Try Again",t.addEventListener("click",r),n.appendChild(t)}o.appendChild(n)}async function loadCatalog(){try{document.body.classList.remove("catalog-load-error"),showLoading("cart-items");const t=await fetch("/assets/data/products.json",{cache:"no-cache",headers:{Accept:"application/json"}});if(!t.ok)throw new Error(`Failed to load product catalog (HTTP ${t.status})`);const e=await t.json();if(!Array.isArray(e.products)||0===e.products.length)throw new Error("Product catalog is empty or invalid");return PRODUCT_MAP={},e.products.forEach((t=>{if(!t||"object"!=typeof t)return;const e=String(t.id||"").trim();if(!e)return;const r=Number(t.price);if(isNaN(r)||r<=0)throw new Error(`Invalid price for product ${e}`);PRODUCT_MAP[e]={price:r,maxQuantity:Math.max(1,Math.min(999,Number(t.maxQuantity)||CATALOG_DEFAULTS.maxQty)),description:t.description||e}})),e.defaults&&"object"==typeof e.defaults&&(Array.isArray(e.defaults.shippingTiers)&&(CATALOG_DEFAULTS.shippingTiers=e.defaults.shippingTiers),e.defaults.currency&&(CATALOG_DEFAULTS.currency=String(e.defaults.currency)),"number"==typeof e.defaults.maxQty&&(CATALOG_DEFAULTS.maxQty=Math.max(1,Math.min(999,e.defaults.maxQty)))),document.getElementById("cart-items").innerHTML="",!0}catch(t){return console.error("Product catalog error:",t),document.body.classList.add("catalog-load-error"),showError("Unable to load product catalog. Please refresh the page or contact support if the problem persists.","cart-items",(()=>window.location.reload())),!1}}function getProductPrice(t){if(!t)return 0;const e=PRODUCT_MAP[String(t)];return e&&Number(e.price)||0}function clampQuantity(t,e){const r=Math.max(0,parseInt(e,10)||0),o=PRODUCT_MAP[String(t)],n=o&&Number(o.maxQuantity)||CATALOG_DEFAULTS.maxQty;return Math.max(1,Math.min(n,r||1))}function computeShipping(t,e){if(!Array.isArray(e)||0===e.length)return 0;for(const r of e)if(t<=(r.max||0))return Number(r.cost)||0;const r=e[e.length-1];return r&&Number(r.cost)||0}const Cart=(()=>{let t=[];return{addToCart:(e,r,o)=>{const n=String(e||""),a=Math.max(0,parseInt(o,10)||0),c=Number(r)||0;if(!n||c<=0||a<=0)return;const i=t.find((t=>t.name===n));i?(i.quantity=a,i.price=c):t.push({name:n,price:c,quantity:a})},removeFromCart:e=>{const r=String(e||"");t=t.filter((t=>t.name!==r))},getCartItems:()=>t,clearCart:()=>{t=[]}}})();function showPreview(t){const e=document.getElementById("preview");e.src=t.src,e.alt=t.alt,e.classList.add("active"),boxColor=t.dataset.name,e.dataset.name=boxColor}function addToCartHandler(){const t=boxColor,e=getProductPrice(t);if(!t||e<=0)return void showError("Please select a product color first");Cart.getCartItems().reduce(((t,e)=>t+e.quantity),0)+boxQty<=(CATALOG_DEFAULTS.maxQty||6)?Cart.addToCart(t,e,boxQty):alert("Maximum quantity reached. You cannot add more items to the cart. If you wish to order more than 6 items, please contact us for wholesale pricing!"),displayCartItems(),saveCartToLocalStorage()}function saveCartToLocalStorage(){const t=Cart.getCartItems();localStorage.setItem("cart",JSON.stringify(t))}function loadCartFromLocalStorage(){const t=localStorage.getItem("cart");if(!t)return;let e=null;try{e=JSON.parse(t)}catch(t){return console.warn("Invalid cart JSON in localStorage, clearing"),void localStorage.removeItem("cart")}if(Array.isArray(e))for(const t of e){const e=String(t.name||""),r=Number(t.price)||getProductPrice(e),o=clampQuantity(e,t.quantity);e&&r>0&&o>0&&Cart.addToCart(e,r,o)}}function removeFromCart(t){Cart.removeFromCart(t),displayCartItems()}function displayCartItems(){const t=Cart.getCartItems(),e=document.getElementById("cart-items"),r=document.getElementById("shipping");e.textContent="",r.textContent="";let o=0,n=0;if(t&&t.length>0)for(const{name:r,price:n,quantity:a}of t){const t=Math.max(0,parseInt(a,10)||0),c=Number(n)||0,i=document.createElement("div");i.classList.add("cart-product"),i.textContent=`${r} - $${c} x ${t}`;const s=document.createElement("button");s.classList.add("remove-button"),s.textContent="X",s.addEventListener("click",(function(){removeFromCart(r)})),i.appendChild(s),e.appendChild(i),o+=c*t}document.getElementById("subtotal").textContent=`$${o.toFixed(2)}`;const a=t.reduce(((t,e)=>t+(parseInt(e.quantity,10)||0)),0),c=computeShipping(a,CATALOG_DEFAULTS.shippingTiers);a>CATALOG_DEFAULTS.maxQty&&alert("If you wish to order more than "+CATALOG_DEFAULTS.maxQty+" items, please contact us for wholesale pricing!");document.getElementById("shipping").textContent=`$${c.toFixed(2)}`,n=o+c;document.getElementById("total").textContent=`$${n.toFixed(2)}`,saveCartToLocalStorage()}function checkout(){const t=Cart.getCartItems();if(!t||0===t.length)return void alert("Your cart is empty. Please add items to your cart before proceeding to checkout.");initPayPalButton(t);document.querySelector(".line-animation").classList.add("expand");const e=document.getElementById("checkout");e&&e.classList.add("hidden");document.getElementById("paypal-button-container").scrollIntoView({behavior:"smooth"})}async function initPayPalButton(t){const e=document.getElementById("paypal-button-container");if("undefined"==typeof paypal)return e.innerHTML='<div class="loading">Loading payment options...</div>',void setTimeout((()=>initPayPalButton(t)),500);e.innerHTML="";try{if(void 0===window.paypal)throw new Error("PayPal SDK not loaded");window.paypal.Buttons({style:{shape:"rect",color:"gold",layout:"vertical",label:"checkout"},createOrder:async function(){try{const t=window.PAYMENT_WORKER_URL||"http://localhost:8787",e=await fetch(`${t}/create-order`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cart:Cart.getCartItems()})});if(!e.ok){const t=await e.json();throw new Error(t.error||"Failed to create order")}const{orderId:r}=await e.json();return r}catch(t){throw console.error("Order creation error:",t),t}},onApprove:async function(t){e.innerHTML='<div class="loading">Processing your payment...</div>';try{const r=window.PAYMENT_WORKER_URL||"http://localhost:8787",o=await fetch(`${r}/capture-order`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderId:t.orderID})});if(!o.ok){const t=await o.json();throw new Error(t.error||"Failed to capture payment")}const n=await o.json();if("COMPLETED"!==n.status)throw new Error(`Order status: ${n.status}`);localStorage.removeItem("cart"),Cart.clearCart(),displayCartItems(),e.innerHTML=`\n              <div class="order-complete">\n                <h3>Thank you for your payment!</h3>\n                <h4>Your order has been submitted.</h4>\n                <p>Order ID: ${n.orderId}</p>\n                <p>If you have any questions or concerns please <a href="/about">get in contact with us</a>.</p>\n              </div>\n            `}catch(t){console.error("Payment capture error:",t),e.innerHTML=`\n            <div class="error-message">\n              <p>Sorry, there was a problem completing your payment: ${t.message}</p>\n              <p>Please <a href="/about">contact us</a> if you believe this is an error.</p>\n            </div>\n          `}},onError:function(t){console.error("PayPal error:",t),e.innerHTML='\n          <div class="error-message">\n            <p>Sorry, there was a problem loading the payment system.</p>\n            <button onclick="initPayPalButton(Cart.getCartItems())">Try Again</button>\n          </div>\n        '}}).render("#paypal-button-container")}catch(t){console.error("Checkout initialization error:",t),e.innerHTML=`\n      <div class="error-message">\n        <p>Sorry, there was a problem preparing checkout: ${t.message}</p>\n        <button onclick="initPayPalButton(Cart.getCartItems())">Try Again</button>\n      </div>\n    `}}async function handlePayPalReturn(){const t=new URLSearchParams(window.location.search).get("token"),e=localStorage.getItem("pendingOrderId");if(!t||t!==e)return;const r=document.getElementById("paypal-button-container");if(r){r.innerHTML='<div class="loading">Processing your payment...</div>',r.scrollIntoView({behavior:"smooth"});try{const e=window.PAYMENT_WORKER_URL||"http://localhost:8787",o=await fetch(`${e}/capture-order`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderId:t})});if(!o.ok){const t=await o.json();throw new Error(t.error||"Failed to capture payment")}const n=await o.json();if("COMPLETED"!==n.status)throw new Error(`Order status: ${n.status}`);localStorage.removeItem("cart"),localStorage.removeItem("pendingOrderId"),Cart.clearCart(),displayCartItems(),r.innerHTML=`\n        <div class="order-complete">\n          <h3>Thank you for your payment!</h3>\n          <h4>Your order has been submitted.</h4>\n          <p>Order ID: ${n.orderId}</p>\n          <p>If you have any questions or concerns please <a href="/about">get in contact with us</a>.</p>\n        </div>\n      `,window.history.replaceState({},document.title,window.location.pathname)}catch(t){console.error("Payment capture error:",t),r.innerHTML=`\n      <div class="error-message">\n        <p>Sorry, there was a problem completing your payment: ${t.message}</p>\n        <p>Please <a href="/about">contact us</a> if you believe this is an error.</p>\n      </div>\n    `}}}document.addEventListener("DOMContentLoaded",(async function(){await loadCatalog();const t=document.getElementsByClassName("thumbnail-image")||[];Array.from(t).forEach((function(t){t.addEventListener("click",(function(){showPreview(t)}))}));const e=document.querySelector(".thumbnail-image");e&&showPreview(e);const r=document.getElementById("quantitySelect");r&&r.addEventListener("change",(function(){boxQty=r.options&&r.options.length>0&&parseInt(r.options[r.selectedIndex].value,10)||1}));const o=document.getElementById("add-cart");o&&o.addEventListener("click",addToCartHandler);const n=document.getElementById("checkout");n&&n.addEventListener("click",checkout),loadCartFromLocalStorage(),displayCartItems(),handlePayPalReturn()}));